<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <title>My first three.js app</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
    </style>
  </head>
  <body>
    <script src="js/three.js"></script>
    <script type="x-shader/x-vertex" id="vertexShader">
      attribute vec3 center;
      varying vec3 vCenter;
      void main() {
        vCenter = center;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
      }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
      varying vec3 vCenter;
      float edgeFactorTri() {
        vec3 d = fwidth( vCenter.xyz );
        vec3 a3 = smoothstep( vec3( 0.0 ), d * 5.0, vCenter.xyz );
        return min( min( a3.x, a3.y ), a3.z );
      }
      void main() {
        gl_FragColor.rgba = mix( vec4( 0.1, 0.4, 0.1, 1.0 ), vec4( 0.0 ), edgeFactorTri() );
      }
    </script>
    <script>
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      // var geometry = new THREE.BoxBufferGeometry( 1, 1, 1 );
      var geometry = new THREE.SphereBufferGeometry( 2, 32, 16 );
      geometry = geometry.toNonIndexed();
      setupAttributes( geometry );


      // var wireframe = new THREE.WireframeGeometry( geometry );
      // var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
      // var cube = new THREE.Mesh( wireframe, material );
      // var material = new THREE.LineBasicMaterial( { color: 0xffffff, linewidth: 10 } );

      material = new THREE.ShaderMaterial( {
                uniforms: {},
                vertexShader: document.getElementById( 'vertexShader' ).textContent,
                fragmentShader: document.getElementById( 'fragmentShader' ).textContent
              } );
      material.extensions.derivatives = true;



      var cube = new THREE.Mesh( geometry, material );
      // cube.material.depthTest = false;
      // cube.material.opacity = 0.25;
      // cube.material.transparent = true;

      scene.add( cube );

      camera.position.z = 5;

      function animate() {
        var gl = renderer.context;
        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

        requestAnimationFrame( animate );
        cube.rotation.x += 0.01;
        cube.rotation.y += 0.01;
        renderer.render( scene, camera );
      }

      function setupAttributes( geometry ) {
        // TODO: Bring back quads
        var vectors = [
          new THREE.Vector3( 1, 0, 0 ),
          new THREE.Vector3( 0, 1, 0 ),
          new THREE.Vector3( 0, 0, 1 )
        ];
        var position = geometry.attributes.position;
        var centers = new Float32Array( position.count * 3 );
        for ( var i = 0, l = position.count; i < l; i ++ ) {
          vectors[ i % 3 ].toArray( centers, i * 3 );
        }
        geometry.addAttribute( 'center', new THREE.BufferAttribute( centers, 3 ) );
      }

      animate();
    </script>
  </body>
</html>